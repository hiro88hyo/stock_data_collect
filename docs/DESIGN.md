**日本株日次データ自動取得アプリ 要件定義書**

**1. はじめに**

*   **1.1. プロジェクトの目的**
    本プロジェクトは、日本の株式市場の日次データを、市場クローズ後に自動で取得し、データ分析や個人的な記録のために永続的に保存することを目的とする。
*   **1.2. 背景**
    本アプリケーションは個人開発プロジェクトであり、開発リソースや運用コストを考慮し、必要十分な機能に絞って実装する。エンタープライズレベルの厳密な非機能要件や複雑な機能は対象外とする。
*   **1.3. 本書の対象読者**
    開発者自身。
*   **1.4. 用語定義**
    *   OHLCV: 始値(Open)、高値(High)、安値(Low)、終値(Close)、出来高(Volume)
    *   J-Quants API: 株式会社JPX総研が提供する、投資分析のためのAPIサービス。

**2. システム概要**

*   **2.1. システム名**
    日本株日次データ自動取得アプリ (仮称)
*   **2.2. システムの概要説明**
    本システムは、Google Cloudプラットフォーム上で動作し、J-Quants APIから日本株の四本値（OHLCV）データを取得し、BigQueryに保存するバッチ処理システムである。処理は市場の営業日のクローズ後に自動実行される。
*   **2.3. 主要な機能一覧**
    *   日本株の日次OHLCVデータ取得
    *   取得データのBigQueryへの保存
    *   過去データの一括取得

**3. 機能要件**

*   **3.1. データ取得機能**
    *   **3.1.1. データソース**
        *   J-Quants APIを利用する。
    *   **3.1.2. 取得対象データ**
        *   日次の株価四本値（OHLCV）を基本とする。
        *   対象は、J-Quants APIが提供する全ての日本株銘柄とする（APIが銘柄指定なしで全銘柄取得可能な場合）。
    *   **3.1.3. 取得タイミング・トリガー**
        *   日本の株式市場の営業日の市場クローズ後（例: 16:00）に自動でデータ取得処理をトリガーする。
        *   トリガーはCloud SchedulerとPub/Subを利用する。
    *   **3.1.4. 市場休日対応**
        *   J-Quants APIが提供する情報に基づき、市場の営業日であるかを判定し、営業日のみデータ取得処理を実行する。
    *   **3.1.5. 過去データ取得機能**
        *   指定した期間の過去データを一括で取得し、BigQueryに保存する機能を実装する。
        *   本機能の実行は手動トリガー（例: Pub/Subへの手動メッセージ送信）を想定する。
        *   APIのレート制限を考慮し、必要に応じて期間を分割してリクエストを行う。

*   **3.2. データ保存機能**
    *   **3.2.1. 保存先**
        *   Google Cloud BigQuery
    *   **3.2.2. テーブル設計**
        *   日次株価データを格納する主要テーブル (`daily_stock_prices` 等) を1つ作成する。
        *   基本的なカラム構成:
            *   `date` (DATE, NOT NULL) - 取引日
            *   `security_code` (STRING, NOT NULL) - 銘柄コード
            *   `open_price` (NUMERIC または FLOAT64) - 始値
            *   `high_price` (NUMERIC または FLOAT64) - 高値
            *   `low_price` (NUMERIC または FLOAT64) - 安値
            *   `close_price` (NUMERIC または FLOAT64) - 終値
            *   `volume` (INTEGER) - 出来高
            *   `created_at` (TIMESTAMP) - レコード作成日時 (BigQueryへの初回登録時)
            *   `updated_at` (TIMESTAMP) - レコード更新日時 (BigQueryへのデータMERGE時)
        *   注: BigQueryのパーティショニング、クラスタリングは初期実装では考慮しない。データ量の増加に応じて将来的に検討する。
    *   **3.2.3. データ冪等性**
        *   同一日のデータ取得処理が複数回実行された場合でも、BigQueryにデータが重複して登録されないようにする。
        *   BigQueryの`MERGE`ステートメントを利用し、取引日と銘柄コードをキーとしてデータの挿入または更新を行う。

*   **3.3. エラーハンドリング**
    *   **3.3.1. APIエラー**
        *   J-Quants APIへのリクエスト時に発生する一時的なエラー（ネットワークエラー、サーバーエラー等）に対しては、数回のリトライ処理（エクスポネンシャルバックオフ等）を実装する。
        *   リトライしても解消しないエラーや、認証エラー等の永続的なエラーの場合は、処理を中断し、エラー内容をログに出力する。
    *   **3.3.2. データ重複登録防止**
        *   機能要件3.2.3. に記載の通り、`MERGE`ステートメントにより重複登録を防止する。

**4. 非機能要件**

*   **4.1. 性能**
    *   全銘柄の日次データを現実的な時間（例: 数十分以内）で取得・保存できること。厳密な性能目標値は設定しない。
*   **4.2. 可用性**
    *   個人利用のため、GCPの標準的なサービスレベルを前提とし、特別な高可用性対策は行わない（ベストエフォート）。
*   **4.3. セキュリティ**
    *   **4.3.1. APIキー管理**
        *   J-Quants APIのAPIキーは、Google Cloud Secret Managerを使用して安全に管理する。
        *   Cloud Runのサービスアカウントには、Secret Managerへの必要最小限のアクセス権限を付与する。
*   **4.4. 運用・保守**
    *   **4.4.1. ロギング**
        *   Cloud Runの標準機能を利用し、処理の開始・終了、主要な処理ステップ、エラー発生時の情報をCloud Loggingに出力する。
    *   **4.4.2. モニタリング**
        *   Cloud Monitoringの標準機能で、Cloud Runの実行状況（実行回数、エラーレート等）を確認できる範囲とする。高度なカスタムメトリクスや専用ダッシュボードの構築は必須としない。
    *   **4.4.3. 通知**
        *   処理の失敗時に自動通知する仕組みは必須としない。必要に応じて手動でログを確認する。
*   **4.5. 開発環境**
    *   **4.5.1. 開発言語**
        *   Python (3.12以上)
    *   **4.5.2. バージョン管理**
        *   Gitを利用し、GitHubでソースコードを管理する。
*   **4.6. インフラストラクチャ**
    *   **4.6.1. プラットフォーム**
        *   Google Cloud
    *   **4.6.2. 主要サービス**
        *   Cloud Run: データ取得処理の実行環境
        *   Cloud Scheduler: 定期実行トリガー
        *   Pub/Sub: Cloud SchedulerとCloud Run間の非同期メッセージング
        *   BigQuery: データ保存先
        *   Secret Manager: APIキー管理
        *   Cloud Build: CI/CDパイプライン (コンテナイメージビルド、デプロイ)
        *   Google Cloud Storage: Terraformのstateファイル保存 (必要に応じて)
    *   **4.6.3. インフラ構成管理**
        *   Terraform
    *   **4.6.4. 環境分離**
        *   開発環境と本番環境の2つの環境をGoogle Cloudプロジェクトレベルで分離する。
        *   TerraformのWorkspace等を利用して、同一コードベースで各環境のインフラを管理する。
        *   APIキーはSecret Managerに手動で登録する。

**5. スコープ外（本プロジェクトで対応しないこと）**

*   複雑なエラーリカバリ処理や、複数ステップにまたがるトランザクション管理。
*   詳細な監査ログの取得・管理。
*   ユーザーインターフェース(UI)の提供。
*   エンタープライズレベルの厳密な監視体制やアラート通知システム（例: 24/365対応）。
*   サービスレベルアグリーメント(SLA)の設定。
*   取得したデータを用いた高度なデータ分析機能や可視化ダッシュボードの提供（本アプリの責務外）。
*   リアルタイム株価取得。
*   J-Quants API以外のデータソースからのデータ取得。